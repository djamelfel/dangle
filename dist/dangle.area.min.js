/*! dangle - v1.0.0 - 2014-10-21
* http://www.fullscale.co/dangle
* Copyright (c) 2014 FullScale Labs, LLC; Licensed MIT */
angular.module("dangle").directive("fsArea",["$compile",function(e){"use strict";return{restrict:"E",scope:{onClick:"=",width:"=",height:"=",bind:"=",xmax:"=",xmin:"=",label:"@",field:"@",duration:"@",delay:"@",plot:"@",pointRadius:"@"},link:function(t,n,r){var i={top:20,right:20,bottom:80,left:80},s=t.width||1280,o=t.height||300,u=r.interpolate||"false",a=r.label||"Frequency",f=r.class||"";s=s-i.left-i.right,o=o-i.top-i.bottom;var l=d3.time.scale().range([0,s]),c=d3.scale.linear().range([o,0]),h=d3.svg.axis().scale(l).orient("bottom"),p=d3.svg.axis().scale(c).orient("left"),d=d3.svg.line().x(function(e){return l(e.time)}).y(function(e){return c(e.count)}),v=d3.svg.area().x(function(e){return l(e.time)}).y0(o).y1(function(e){return c(e.count)});r.interpolate=="true"&&(d.interpolate("cardinal"),v.interpolate("cardinal"));var m=d3.select(n[0]).append("svg").attr("preserveAspectRatio","xMinYMin").attr("viewBox","0 0 "+(s+i.left+i.right)+" "+(o+i.top+i.bottom)).append("g").attr("transform","translate("+i.left+","+i.top+")");m.append("g").attr("class","x dg-axis "+f).attr("transform","translate(0,"+o+")").call(h),m.append("g").attr("class","y dg-axis "+f).call(p).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text(a),t.$watch("bind",function(i){var s=t.duration||0,o=t.delay||0,u=t.plot||"true",a=t.pointRadius||8,g=t.field||r.bind.split(".").pop().toLowerCase();m.selectAll(".curve").remove();if(i!==undefined&&i.length!=0){i=i.entries||[];var b={};for(var w=0;w<i.length;w++)b[i[w].label]===undefined&&(b[i[w].label]=[]),b[i[w].label].push(i[w]);var E=0;for(var S in b){var T=m.append("g").attr("class","curve dg-curve"+E),N=T.append("g").attr("ng-init","sh"+E+"=true").attr("ng-show","sh"+E);N.append("path").datum([]).attr("class","dg-fill "+f).attr("d",v),N.append("path").datum([]).attr("class","dg-line "+f).attr("d",d);var C=t.xmin||d3.min(i,function(e){return e.time}),k=t.xmax||d3.max(i,function(e){return e.time});l.domain([C,k]);var L=d3.min(i,function(e){return e.count});L<0?L:L=0,c.domain([L,d3.max(i,function(e){return e.count})]);var A=T.transition().duration(s);A.select(".dg-fill").attr("d",v(b[S])),A.select(".dg-line").attr("d",d(b[S])),N=T.append("g").attr("ng-click","sh"+E+" = !sh"+E).attr("class","pointer");var O=150;N.append("circle").attr("cx",E*O).attr("cy",250).attr("r",8),N.append("text").attr("x",E*O+12).attr("y",255).text(S);if(u=="true"){var M=m.selectAll(".circle").data(i.filter(function(e){return e.count}),function(e){return Math.random()});M.enter().append("circle").attr("class","pointer circle dg-line dg-points "+f).attr("cx",d.x()).attr("cy",d.y()).style("opacity",0).transition().duration(s).style("opacity",1).attr("cx",d.x()).attr("cy",d.y()).attr("r",a),M.on("mousedown",function(e){t.$apply(function(){(t.onClick||angular.noop)(g,e.time)})}),M.exit().remove()}E++}var A=m.transition().duration(s);A.select(".x").call(h),A.select(".y").call(p)}e(n.contents())(t)},!0)}}}]);